//Editando proyecto



// Funcion para cargar el catalogo de libros
void cargarCatalogo(){
    ifstream archivo("catalogo.txt"); // Abre el archivo para leerlo

    if(!archivo.is_open()){ // Verifica si el archivo se abrió correctamente
      cout<<"No se pudo abrir el archivo. \n";
      return;
    }
  try{

    string linea;
    while(getline(archivo, linea)){ // Lee cada línea del archivo
      if (linea.empty()) continue;// Salta las líneas vacías

      stringstream ss(linea); // Ayuda a dividir la línea en partes
      Libro libro; // Crea una estructura para almacenar la información del libro
      string copias;

      getline(ss, libro.id, '|');
      getline(ss, libro.titulo, '|');
      getline(ss, libro.autor, '|');
      getline(ss, copias, '|');
      libro.copias = stoi(copias); // Convierte la cadena a entero

      catalogo.push_back(libro); // Agrega el libro al catálogo
    }
    archivo.close();
  }catch (...){ // Captura cualquier excepción que ocurra durante la lectura del archivo
    cout << "Error al cargar el catalogo. \n";
  }
}

// Funcion para guardar dentro del catalogo de libros
void guardarCatalogo(){
  ofstream archivo("catalogo.txt"); // Abre el archivo para escribirlo

  if(!archivo.is_open()){
    cout << "No se pudo abrir el archivo. \n";
    return;
  }

  for(const auto& libro : catalogo){ // Recorre el catálogo de libros sin modificarlo
    archivo << libro.id << "|" << libro.titulo << "|" << libro.autor << "|" << libro.copias << "\n"; // Escribe la información del libro en el archiv0
  }
  archivo.close(); // Cierra el archivo
}

// Funcion para cargar los prestamos
void cargarPrestamos(){

  ifstream archivo("prestamos.txt"); // Abre el archivo para leerlo

  if(!archivo.is_open()){ // Verifica si el archivo se abrió correctamente
    cout << "No se pudo abrir el archivo. \n";
    return;
  }
  try{

    string linea;
    while(getline(archivo, linea)){ // Lee cada línea del archivo
      if (linea.empty()) continue; // Salta las líneas vacías

      stringstream ss(linea); // Ayuda a dividir la línea en partes
      Prestamo prestamo; // Crea una estructura para almacenar la información del préstamo

      getline(ss, prestamo.idAlumno, '|');
      getline(ss, prestamo.nombreAlumno, '|');
      getline(ss, prestamo.idLibro, '|');
      getline(ss, prestamo.fecha, '|');

      prestamos.push_back(prestamo); // Agrega el préstamo al vector
    }
    archivo.close();
  }catch (... ){ // Captura cualquier excepción que ocurra durante la lectura del archivo
    cout << "Error al cargar los prestamos. \n";
  }
}

// Funcion para guardar los prestamos
void guardarPrestamos(){
  ofstream archivo("prestamos.txt"); // Abre el archivo para escribirlo

  if(!archivo.is_open()){ // Verifica si el archivo se abrió correctamente
    cout << "No se pudo abrir el archivo. \n";
    return;
  }
  for(const auto& prestamo : prestamos){ // Recorre el vector de préstamos sin modificarlo
    archivo << prestamo.idAlumno << "|" << prestamo.nombreAlumno << "|" << prestamo.idLibro << "|" << prestamo.fecha << "\n"; // Escribe la información del préstamo en el archivo
  }
  archivo.close(); // Cierra el archivo
}






//********************************************************************

//FUNCIONES DEL MENU

//Opcion 1: Ingresar registro al catalogo
void ingresarLibro() {

    while (true) {

        // Verficar el ID
        string id;
        while (true) {
            cout << endl;
            cout << "Ingrese ID del libro (6 dígitos max): ";
            getline(cin, id);

            if (id.empty()) {
                cout << "El ID no puede estar en blanco.\n";
                continue;
            }

            if (!validarEntrada(id)) {
                cout << endl;
                cout << "El ID solo debe contener números.\n";
                continue;
            }

            if (id.size() > 6) {
                cout << endl;
                cout << "El ID no debe exceder 6 dígitos.\n";
                continue;
            }

            bool existe = false;
            for (const auto& libro : catalogo) {
                if (libro.id == id) { // Verificar si el ID ya existe
                    existe = true;
                    break;
                }
            }

            if (existe) {
                cout << endl;
                cout << "ID ya existe.\n";
                continue;
            }

            break; // ID válido y se sale del bucle
        }

        // Verificar el título
        string titulo;
        while (true) {
            cout << "Ingrese el nombre del libro: ";
            getline(cin, titulo);

            if (titulo.empty()) {
                cout << "El título no puede estar vacío.\n";
                continue;
            }

            break; // Título válido y se sale del bucle
        }

        // Verificar el autor
        string autor;
        while (true) {
            cout << "Ingrese el nombre del autor: ";
            getline(cin, autor);

            if (autor.empty()) {
                cout << "El autor no puede estar vacío.\n";
                continue;
            }

            break; // Autor válido y se sale del bucle
        }

        // Verificar el número de copias
        string copias;
        int numeroCopias;
        while (true) {
            cout << "Ingrese número de copias (0 a 9): ";
            getline(cin, copias);

            if (!validarEntrada(copias)) {
                cout << "Solo se permiten números (0-9).\n";
                continue;
            }

            numeroCopias = stoi(copias); // Convertir a entero

            if (numeroCopias < 0 || numeroCopias > 9) {
                cout << "Debe estar en el rango 0 a 9.\n";
                continue;
            }

            break; // Valor válido y se sale del bucle
        }

        // Agregar el libro al catálogo
        Libro nuevo;
        nuevo.id = id;
        nuevo.titulo = titulo;
        nuevo.autor = autor;
        nuevo.copias = numeroCopias;

        catalogo.push_back(nuevo);
        guardarCatalogo();

        cout << "Libro agregado exitosamente.\n";

        // Preguntar si desea regresar al menú
        string opcion;
        while (true) {
            cout << "¿Desea regresar al menú? (S = Sí, N = No): ";
            getline(cin, opcion);

            if (opcion == "S" || opcion == "s") {
                return; // Sale de la función y regresa al menú
            }
            else if (opcion == "N" || opcion == "n") {
                break; // Vuelve al inicio del while(true)
            }
            else {
                cout << "Opción inválida.\n";
            }
        }
    }
}

//Opcion 2: Mostrar catalogo
void mostrarCatalogo() {


    while (true) {

       system("cls");

        cout << "=========== CATALOGO DE LIBROS ===========" << endl;

        if (catalogo.empty()) {
            cout << endl;
            cout << "No hay libros registrados en el catalogo." << endl;
        }
        else {
            // Encabezados tipo tabla
            cout << left
                 << setw(10) << "ID"
                 << setw(30) << "Titulo"
                 << setw(25) << "Autor"
                 << setw(10) << "Copias"
                 << endl;

            cout << string(75, '-') << endl;

            // Mostrar cada libro
            for (const auto& libro : catalogo) {
                cout << left
                     << setw(10) << libro.id
                     << setw(30) << libro.titulo
                     << setw(25) << libro.autor
                     << setw(10) << libro.copias
                     << endl;
            }

            cout << "\nTotal de libros registrados: " << catalogo.size() << endl << endl;
        }
        // Preguntar si desea regresar al menú
        string opcion;
        while (true){
            cout << endl;
            cout << "¿Desea regresar al menu? (S = Si, N = No): ";
            getline(cin, opcion);
            if (opcion == "S" || opcion == "s"){
                return; // Sale de la función y regresa al menú
            }
            else if (opcion == "N" || opcion == "n"){
              break; // Vuelve al inicio del while(true)
            }
            else{
                cout << endl;
                cout << "Opcion invalida.\n";
            }
        }
    }
}

//Opcion 3: Registrar nuevo prestamo
void registrarPrestamo() {

    while (true) {

        cout << "========== REGISTRAR PRESTAMO ==========" << endl << endl;

        // ======== 1. ID ALUMNO ========
        string idAlumno;
        while (true) {
            cout << "Ingrese ID del alumno (9 digitos): ";
            getline(cin, idAlumno);

            if (idAlumno.empty()) {
                cout << "El ID no puede estar en blanco.\n";
                continue;
            }
            if (!validarEntrada(idAlumno)) {
                cout << "Solo se permiten numeros.\n";
                continue;
            }
            if (idAlumno.size() != 9) {
                cout << "El ID debe tener exactamente 9 digitos.\n";
                continue;
            }
            break;
        }

        // ======== 2. ID DEL LIBRO ========
        string idLibro;
        int indiceLibro = -1;

        pedirLibroDeNuevo:

        while (true) {
            cout << "Ingrese ID del libro (6 digitos): ";
            getline(cin, idLibro);

            if (idLibro.empty()) {
                cout << "El ID no puede estar en blanco.\n";
                continue;
            }
            if (!validarEntrada(idLibro)) {
                cout << "Solo se permiten numeros.\n";
                continue;
            }
            if (idLibro.size() != 6) {
                cout << "El ID debe tener exactamente 6 digitos.\n";
                continue;
            }

            // Buscar libro en el catálogo
            indiceLibro = -1;
            for (int i = 0; i < catalogo.size(); i++) {
                if (catalogo[i].id == idLibro) {
                    indiceLibro = i;
                    break;
                }
            }

            if (indiceLibro == -1) {
                cout << "El ID de libro no existe.\n";
                continue;
            }

            break;
        }

        // Mostrar info del libro encontrado
        cout << "\nLibro encontrado: " << catalogo[indiceLibro].titulo << endl;
        cout << "Copias disponibles: " << catalogo[indiceLibro].copias << endl;

        // NO HAY COPIAS DISPONIBLES
        if (catalogo[indiceLibro].copias == 0) {
            cout << "\nNo hay copias disponibles de este libro.\n";
            cout << "¿Desea solicitar otro libro? (S/N): ";
            string op;
            getline(cin, op);

            if (op == "S" || op == "s") {
                goto pedirLibroDeNuevo;   // ← reinicia sólo la parte del ID libro
            }
            else {
                return;  // volver al menú
            }
        }

        // ======== 3. NOMBRE DEL ALUMNO ========
        string nombreAlumno;
        while (true) {
            cout << "\nIngrese el nombre del alumno: ";
            getline(cin, nombreAlumno);

            if (nombreAlumno.empty()) {
                cout << "El nombre no puede estar en blanco.\n";
                continue;
            }
            break;
        }

        // ======== 4. FECHA ========
        // Generar fecha actual
        time_t t = time(0);
        tm* now = localtime(&t);

        char fechaActual[11];
        strftime(fechaActual, 11, "%d/%m/%Y", now);

        string fechaPrestamo = fechaActual;

        cout << "\nFecha sugerida del prestamo: " << fechaPrestamo << endl;
        cout << "¿Desea modificar la fecha? (S/N): ";
        string cambiarFecha;
        getline(cin, cambiarFecha);

        if (cambiarFecha == "S" || cambiarFecha == "s") {
            cout << "Ingrese nueva fecha (DD/MM/YYYY): ";
            getline(cin, fechaPrestamo);
        }

        // ======== CONFIRMAR PRESTAMO ========
        cout << "\nSe encontraron copias disponibles." << endl;
        cout << "¿Desea confirmar el prestamo? (S/N): ";
        string confirmar;
        getline(cin, confirmar);

        if (confirmar == "N" || confirmar == "n") {
            cout << "\nPrestamo cancelado.\n";
        }
        else {
            // Registrar y actualizar
            Prestamo nuevo;
            nuevo.idAlumno = idAlumno;
            nuevo.nombreAlumno = nombreAlumno;
            nuevo.idLibro = idLibro;
            nuevo.fecha = fechaPrestamo;

            prestamos.push_back(nuevo);

            catalogo[indiceLibro].copias--;

            guardarCatalogo(); // actualiza el archivo
            cout << "\nPrestamo registrado correctamente.\n";
        }

        // ======== SALIR O REPETIR ========
        cout << "\n¿Desea volver al menu principal? (S/N): ";
        string opcion;
        getline(cin, opcion);

        if (opcion == "S" || opcion == "s") {
            return;
        }

    }
}

//Opcion 4: Devolver libro
void devolverLibro() {

    while (true) {

        cout << "=========== DEVOLVER LIBRO ===========" << endl << endl;

        // ======== 1. ID ALUMNO =========
        string idAlumno;

        pedirAlumnoDeNuevo:

        while (true) {
            cout << "Ingrese ID del alumno (9 digitos): ";
            getline(cin, idAlumno);

            if (idAlumno.empty()) {
                cout << "El campo no puede estar vacio.\n";
                continue;
            }
            if (!validarEntrada(idAlumno)) {
                cout << "Solo se permiten numeros.\n";
                continue;
            }
            if (idAlumno.size() != 9) {
                cout << "Debe contener exactamente 9 digitos.\n";
                continue;
            }
            break;
        }

        // ======== 2. Buscar prestamos del alumno ========
        vector<int> indicesPrestamos;

        for (int i = 0; i < prestamos.size(); i++) {
            if (prestamos[i].idAlumno == idAlumno) {
                indicesPrestamos.push_back(i);
            }
        }

        // No existe alumno ni préstamos
        if (indicesPrestamos.empty()) {
            cout << "\nAlumno no registrado o no tiene prestamos.\n";
            cout << "¿Desea consultar otro alumno? (S/N): ";
            string op;
            getline(cin, op);

            if (op == "S" || op == "s") {

                goto pedirAlumnoDeNuevo;
            }
            else {

                return;
            }
        }

        // Mostrar los libros prestados por ese alumno
        cout << "\nLibros prestados por el alumno:\n";
        cout << left << setw(10) << "ID Libro"
             << setw(30) << "Titulo"
             << setw(20) << "Fecha" << endl;
        cout << string(60, '-') << endl;

        for (int idx : indicesPrestamos) {
            string idLibroPrestado = prestamos[idx].idLibro;

            // Buscar título del libro
            string titulo = "";
            for (const auto& l : catalogo) {
                if (l.id == idLibroPrestado) {
                    titulo = l.titulo;
                    break;
                }
            }

            cout << left << setw(10) << idLibroPrestado
                 << setw(30) << titulo
                 << setw(20) << prestamos[idx].fecha << endl;
        }

        // ======== 3. Pedir ID del libro a devolver ========
        string idLibro;
        int indicePrestamo = -1;

        while (true) {
            cout << "\nIngrese el ID del libro a devolver (6 digitos): ";
            getline(cin, idLibro);

            if (idLibro.empty()) {
                cout << "No puede estar vacio.\n";
                continue;
            }
            if (!validarEntrada(idLibro)) {
                cout << "Solo se permiten numeros.\n";
                continue;
            }
            if (idLibro.size() != 6) {
                cout << "Debe contener 6 digitos.\n";
                continue;
            }

            // Buscar préstamo exacto
            for (int idx : indicesPrestamos) {
                if (prestamos[idx].idLibro == idLibro) {
                    indicePrestamo = idx;
                    break;
                }
            }

            if (indicePrestamo == -1) {
                cout << "Dato incorrecto. Ese libro no esta prestado a este alumno.\n";
                continue;
            }

            break;
        }

        // ======== MOSTRAR DATOS DEL PRESTAMO ========
        cout << "\nDatos del prestamo encontrado:\n";
        cout << "Alumno: " << prestamos[indicePrestamo].nombreAlumno << endl;
        cout << "ID Libro: " << prestamos[indicePrestamo].idLibro << endl;
        cout << "Fecha: " << prestamos[indicePrestamo].fecha << endl;

        // ======== CONFIRMAR DEVOLUCION ========
        cout << "\n¿Desea confirmar la devolucion? (S/N): ";
        string confirmar;
        getline(cin, confirmar);

        if (confirmar == "S" || confirmar == "s") {

            // 1. Aumentar copias en catálogo
            for (auto& libro : catalogo) {
                if (libro.id == idLibro) {
                    libro.copias++;
                    break;
                }
            }

            // 2. Remover el prestamo
            prestamos.erase(prestamos.begin() + indicePrestamo);

            // 3. Guardar catálogo
            guardarCatalogo();

            cout << "\nDevolucion registrada correctamente.\n";
        }
        else {
            cout << "\nDevolucion cancelada.\n";
        }

        // ======== SALIR O REPETIR ========
        cout << "\n¿Desea volver al menu principal? (S/N): ";
        string opcion;
        getline(cin, opcion);

        if (opcion == "S" || opcion == "s") {
            return;
        }


    }
}

//Opcion 5: Ver historial de prestamos
void verHistorialPrestamos() {

    while (true) {


        cout << "=========== HISTORIAL DE PRESTAMOS ===========" << endl << endl;

        if (prestamos.empty()) {
            cout << "No hay prestamos registrados." << endl << endl;
        }
        else {

            // Encabezado tipo tabla
            cout << left
                 << setw(12) << "ID Alumno"
                 << setw(25) << "Nombre"
                 << setw(12) << "ID Libro"
                 << setw(12) << "Fecha"
                 << endl;

            cout << string(70, '-') << endl;

            // Mostrar cada préstamo
            for (const auto& p : prestamos) {
                cout << left
                     << setw(12) << p.idAlumno
                     << setw(25) << p.nombreAlumno
                     << setw(12) << p.idLibro
                     << setw(12) << p.fecha
                     << endl;
            }

            cout << "\nTotal de prestamos realizados: " << prestamos.size() << endl << endl;
        }

        // Preguntar si desea volver al menú
        string opcion;
        cout << "¿Desea volver al menú principal? (S/N): ";
        getline(cin, opcion);

        if (opcion == "S" || opcion == "s") {

            return;  // salir de la función → regresa al menú
        }
        else if (opcion == "N" || opcion == "n") {

            continue; // vuelve a mostrar el historial
        }
        else {
            cout << "Opción inválida.";
        }
    }
}





//********************************************************************
int main(){

  cargarCatalogo();
  cargarPrestamos();

  int opcion;
  do{

    system("cls");



    cout << "\n====================================\n";
    cout << "     SISTEMA DE BIBLIOTECA\n";
    cout << "====================================\n";
    cout << "1. Ingresar registro al catalogo\n";
    cout << "2. Mostrar catalogo\n";
    cout << "3. Registrar nuevo prestamo\n";
    cout << "4. Devolver libro\n";
    cout << "5. Ver historial de prestamos\n";
    cout << "6. Salir\n";
    cout << "\nIngrese una opcion: ";
    cin >> opcion;

    cin.ignore(numeric_limits<streamsize>::max(), '\n');


    switch(opcion){
      case 1:
        system("cls");
        ingresarLibro();
        break;
      case 2:
        system("cls");
        mostrarCatalogo();
        break;
      case 3:
        system("cls");
        registrarPrestamo();
        break;
      case 4:
        system("cls");
        devolverLibro();
        break;
      case 5:
        system("cls");
        verHistorialPrestamos();
        break;
      case 6:
        system("cls");
        cout << "Saliendo del programa...\n";
        break;
      default:
        system("cls");
        cout << "Opción inválida. Intente de nuevo.\n";
    }

  }while(opcion != 6);




  return 0;
}

